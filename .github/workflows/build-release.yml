name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 当推送版本标签时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: windows-latest  # 使用 Windows 构建 .exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build executable
      run: |
        python build.py

    - name: Verify build output
      run: |
        if (Test-Path "release/bilibili-ai-partition.exe") {
          Write-Host "✅ Build successful - executable found"
          Get-ChildItem release/ | Format-Table Name, Length
        } else {
          Write-Host "❌ Build failed - executable not found"
          Get-ChildItem -Recurse | Where-Object {$_.Name -like "*.exe"} | Format-Table FullName, Length
          exit 1
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bilibili-ai-partition-windows
        path: release/

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        files: |
          release/bilibili-ai-partition.exe
          release/README.md
          release/requirements.txt
          release/使用说明.txt
        body: |
          ## 🎉 bilibili-ai-partition ${{ github.ref_name }}

          ### 📦 下载说明
          - 下载 `bilibili-ai-partition.exe` 即可使用
          - 首次使用请运行配置向导
          - 详细使用说明请查看 README.md

          ### ✨ 功能特性
          - 🤖 AI智能分析UP主类型
          - 📊 自动创建分组并批量分配
          - 🔍 支持试运行模式
          - ⚙️ 可配置AI分析批次大小

          ### 🔒 安全提醒
          - 请妥善保管你的Cookie和API密钥
          - 不要在公共场所使用
          - 定期更换密钥以确保安全
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}