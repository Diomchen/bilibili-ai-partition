name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: windows-latest  # ä½¿ç”¨ Windows æ„å»º .exe

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build executable
      run: |
        python build.py

    - name: Verify build output
      run: |
        if (Test-Path "release/bilibili-ai-partition.exe") {
          Write-Host "âœ… Build successful - executable found"
          Get-ChildItem release/ | Format-Table Name, Length
        } else {
          Write-Host "âŒ Build failed - executable not found"
          Get-ChildItem -Recurse | Where-Object {$_.Name -like "*.exe"} | Format-Table FullName, Length
          exit 1
        }
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bilibili-ai-partition-windows
        path: release/

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        files: |
          release/bilibili-ai-partition.exe
          release/README.md
          release/requirements.txt
          release/ä½¿ç”¨è¯´æ˜.txt
        body: |
          ## ğŸ‰ bilibili-ai-partition ${{ github.ref_name }}

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - ä¸‹è½½ `bilibili-ai-partition.exe` å³å¯ä½¿ç”¨
          - é¦–æ¬¡ä½¿ç”¨è¯·è¿è¡Œé…ç½®å‘å¯¼
          - è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·æŸ¥çœ‹ README.md

          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸ¤– AIæ™ºèƒ½åˆ†æUPä¸»ç±»å‹
          - ğŸ“Š è‡ªåŠ¨åˆ›å»ºåˆ†ç»„å¹¶æ‰¹é‡åˆ†é…
          - ğŸ” æ”¯æŒè¯•è¿è¡Œæ¨¡å¼
          - âš™ï¸ å¯é…ç½®AIåˆ†ææ‰¹æ¬¡å¤§å°

          ### ğŸ”’ å®‰å…¨æé†’
          - è¯·å¦¥å–„ä¿ç®¡ä½ çš„Cookieå’ŒAPIå¯†é’¥
          - ä¸è¦åœ¨å…¬å…±åœºæ‰€ä½¿ç”¨
          - å®šæœŸæ›´æ¢å¯†é’¥ä»¥ç¡®ä¿å®‰å…¨
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}